var createDomain = require('domain').create

var domainMiddleware = module.exports = function(req, res, next) {
  var domain = createDomain();
  domain.id = domainMiddleware.id(req);
  domain.add(req);
  domain.add(res);
  domain.run(function() {
  next();
  });
  domain.on('error', function(e) {
    console.error('An error occurred :', e.message);
    $arr['message'] = e.message;
  var common = require('../../module/common');
  common.tplFile('error.tpl');
  common.headerSet(1);
  common.loadTemplateHeader(req,res,$arr);
  
  //next(e);
  
  });
};

var count = 0;
//you can replace this method to
//supply your own id builder
domainMiddleware.id = function(req) {
  return new Date().getTime() + (count++);
};
